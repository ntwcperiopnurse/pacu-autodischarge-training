<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PACU Nurse Training Record - Cloud Sync</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
  
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; background-color: #f0f4f8; margin: 0; padding: 20px; color: #2c3e50; }
    .container { max-width: 1450px; margin: 0 auto; background: white; padding: 35px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: #1a5276; margin: 0 0 8px; }
    .subtitle { text-align: center; color: #555; margin: 0 0 1.5rem; font-size: 1.2rem; }
    
    .dashboard { background: #f8fbff; border: 1px solid #d6e9ff; border-radius: 10px; padding: 25px; margin-bottom: 2.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 25px; }
    .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 3px 12px rgba(0,0,0,0.06); text-align: center; }
    .stat-value { font-size: 2.4rem; font-weight: bold; color: #2980b9; }
    
    .progress-bar-container { height: 24px; background: #e9ecef; border-radius: 12px; overflow: hidden; margin-top: 10px; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); transition: width 0.5s; width: 0%; }
    
    .search-box { text-align: center; margin-bottom: 1.5rem; }
    .search-box input { width: 100%; max-width: 500px; padding: 12px; border: 2px solid #3498db; border-radius: 8px; font-size: 1rem; }
    
    .sync-status { text-align: center; font-size: 0.95rem; margin-bottom: 10px; color: #27ae60; font-weight: bold; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid #999; text-align: center; }
    th { background-color: #2980b9; color: white; font-weight: 600; }
    
    .row-complete { background-color: #d4efdf !important; }
    .count { font-weight: bold; color: #c85400; }
    
    button { padding: 12px 24px; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 5px; font-weight: bold; font-size: 1rem; }
    .save-btn { background-color: #27ae60; }
    .export-btn { background-color: #d35400; }
    
    .login-form { max-width: 400px; margin: 0 auto; padding: 50px 0; }
    input[type="date"] { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-family: inherit; }
  </style>
</head>
<body>

<div class="container" id="loginPage">
  <h1>Nurse Training Record System</h1>
  <div class="login-form">
    <label>Username</label>
    <input type="text" id="username" style="width:100%; padding:10px; margin-bottom:20px;">
    <label>Password</label>
    <input type="password" id="password" style="width:100%; padding:10px; margin-bottom:20px;">
    <button onclick="handleLogin()" style="width:100%; background:#2980b9;">Sign In</button>
    <p id="errorMsg" style="color:red; text-align:center;"></p>
  </div>
</div>

<div class="container" id="mainPage" style="display:none;">
  <h1>PACU Nurse Led Auto Discharge Training</h1>
  <div class="subtitle">üè• Clinical Competency & Training Management</div>

  <div class="dashboard">
    <div class="stat-card"><h3>Total Staff</h3><div class="stat-value" id="totalNurses">0</div></div>
    <div class="stat-card"><h3>Completed</h3><div class="stat-value" id="trainedNurses">0</div></div>
    <div class="stat-card" style="grid-column: span 2;">
      <h3>Overall Completion Progress</h3>
      <div class="progress-bar-container"><div class="progress-bar" id="progressBar"></div></div>
      <p id="completionRate" style="text-align:center; margin-top:5px;">0% Qualified</p>
    </div>
  </div>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Type nurse name to search..." oninput="searchNurse()">
  </div>

  <div id="syncStatus" class="sync-status">üì° Syncing with Cloud...</div>

  <table>
    <thead>
      <tr>
        <th>Rank</th>
        <th>Nurse Name</th>
        <th style="background:#1a5276;">Lecture Date</th>
        <th>Case 1</th>
        <th>Case 2</th>
        <th>Case 3</th>
        <th>Case 4</th>
        <th>Case 5</th>
        <th>Total Cases</th>
      </tr>
    </thead>
    <tbody id="nurseList"></tbody>
  </table>

  <div style="text-align:center; margin-top:40px;">
    <button class="save-btn" onclick="saveToCloud()">üíæ Save & Sync Data</button>
    <button class="export-btn" onclick="exportToCSV()">üìä Download Excel Report</button>
  </div>
</div>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyD3AFw22hvG_45FB3RMPdaccyA8VI-IDxI",
  databaseURL: "https://pacu-auto-discharge-training-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const CORRECT_USER = "periop";
const CORRECT_PASS = "1234";

const nurses = [
  {rank: "APN", name: "CHAN Suet Fan"}, {rank: "APN", name: "CHAN Yuen Fun"}, {rank: "APN", name: "CHENG Mei Ling"},
  {rank: "APN", name: "CHEUNG Hoi Ching"}, {rank: "APN", name: "CHEUNG Mei Yi"}, {rank: "APN", name: "CHOI Yee Ki"},
  {rank: "APN", name: "HUNG Po Lam Mimi"}, {rank: "APN", name: "KO Wan Yiu"}, {rank: "APN", name: "KONG Tsui Yi"},
  {rank: "APN", name: "KWOK Lai Fan"}, {rank: "APN", name: "LAI Pui Kuan"}, {rank: "APN", name: "LAM Lok Yin"},
  {rank: "APN", name: "LAM Ting Ting"}, {rank: "APN", name: "LEE Wai Shan"}, {rank: "APN", name: "LEUNG Siu Chun Chloe"},
  {rank: "APN", name: "LEUNG Wing Sum"}, {rank: "APN", name: "LI Wai Yi"}, {rank: "APN", name: "LIM Pik Yee"},
  {rank: "APN", name: "LO Chi Wah"}, {rank: "APN", name: "NG Kit Ying"}, {rank: "APN", name: "NG Wing Yan Vim"},
  {rank: "APN", name: "TAM Siu Kwan"}, {rank: "APN", name: "TAM Yuen Kwei"}, {rank: "APN", name: "TSO Mei Ling"},
  {rank: "APN", name: "WAN Nga Wai"}, {rank: "APN", name: "WONG Ka Man"}, {rank: "APN", name: "WONG Mei"},
  {rank: "APN", name: "WONG Pui Ki"}, {rank: "APN", name: "WONG Pui Pui"}, {rank: "EN", name: "CHAI Mo Yuet"},
  {rank: "EN", name: "CHAN Fo"}, {rank: "EN", name: "HO Lai Ying"}, {rank: "EN", name: "LAM Man Yee"},
  {rank: "EN", name: "TANG Mei Ping"}, {rank: "EN", name: "WAN Siu Ying"}, {rank: "EN", name: "YIP Kit Yan"},
  {rank: "RN", name: "CHAN Cheuk Laam"}, {rank: "RN", name: "CHAN Ching Laam Elly"}, {rank: "RN", name: "CHAN Gei Tung"},
  {rank: "RN", name: "CHAN Hiu Tung"}, {rank: "RN", name: "CHAN Ka Hin"}, {rank: "RN", name: "CHAN Ka Yan"},
  {rank: "RN", name: "CHAN Man Leuk"}, {rank: "RN", name: "CHAN Nga Lam"}, {rank: "RN", name: "CHAN Shuk Yan"},
  {rank: "RN", name: "CHAN Suet Lam Sharon"}, {rank: "RN", name: "CHAN Tsz Kwan"}, {rank: "RN", name: "CHAN Tsz Ying"},
  {rank: "RN", name: "CHAN Wai Shan"}, {rank: "RN", name: "CHAN Yan Ho"}, {rank: "RN", name: "CHAN Yeuk Tsin"},
  {rank: "RN", name: "CHAU Choi Yin"}, {rank: "RN", name: "CHEUNG Kwok Yuen Carol"}, {rank: "RN", name: "CHEUNG Lai Chun"},
  {rank: "RN", name: "CHEUNG Pak Ho"}, {rank: "RN", name: "CHEUNG Pui Sze"}, {rank: "RN", name: "CHEUNG Tsz Kiu"},
  {rank: "RN", name: "CHI Wai Fung"}, {rank: "RN", name: "CHOI Fung Sin"}, {rank: "RN", name: "CHOW Wing Gi Venus"},
  {rank: "RN", name: "CHUN Yuk Man"}, {rank: "RN", name: "FONG Pui Yu"}, {rank: "RN", name: "FONG Tsz Kwan Phoebe"},
  {rank: "RN", name: "FUNG Yan Tung"}, {rank: "RN", name: "FUNG Yim Ying"}, {rank: "RN", name: "GEORGE Anila"},
  {rank: "RN", name: "HE Hingping"}, {rank: "RN", name: "HO Chun Wang"}, {rank: "RN", name: "HO I Neng"},
  {rank: "RN", name: "HO Ka Ki"}, {rank: "RN", name: "HUANG Linghong"}, {rank: "RN", name: "IP Wai Yee"},
  {rank: "RN", name: "KAM Yuen Kwan"}, {rank: "RN", name: "KO Yan Chi"}, {rank: "RN", name: "KONG Kwai Leung"},
  {rank: "RN", name: "KONG Siu Ching"}, {rank: "RN", name: "KUNG Hoi Ling"}, {rank: "RN", name: "KWOK Hin Tung"},
  {rank: "RN", name: "KWOK Hoi Lam"}, {rank: "RN", name: "KWOK Hoi Ying"}, {rank: "RN", name: "KWOK Kwan Yee"},
  {rank: "RN", name: "KWOK Yuen Ting"}, {rank: "RN", name: "KWONG Tsz Ying Candy"}, {rank: "RN", name: "LAI Ka Wai"},
  {rank: "RN", name: "LAI Wing Tung"}, {rank: "RN", name: "LAI Ya Ching"}, {rank: "RN", name: "LAM Hoi Kiu"},
  {rank: "RN", name: "LAM Tung Yi"}, {rank: "RN", name: "LAU Mei Ting"}, {rank: "RN", name: "LAU Mung Sze"},
  {rank: "RN", name: "LAW Ka Yan"}, {rank: "RN", name: "LEE Pui Ling"}, {rank: "RN", name: "LEUNG Hiu Tung Kylie"},
  {rank: "RN", name: "LEUNG Ping Laam"}, {rank: "RN", name: "LEUNG Suen Lam"}, {rank: "RN", name: "LI Wai Tak"},
  {rank: "RN", name: "LIM Sin Tong"}, {rank: "RN", name: "LIN Man Yan"}, {rank: "RN", name: "LO Chi Kit"},
  {rank: "RN", name: "LUE Siu Fong"}, {rank: "RN", name: "NG Tsz Ching"}, {rank: "RN", name: "NG Wan Hin"},
  {rank: "RN", name: "NUNG Oi Lan"}, {rank: "RN", name: "PANG Wing Yi"}, {rank: "RN", name: "PANG Yi"},
  {rank: "RN", name: "POON Man See Mancy"}, {rank: "RN", name: "RAI Nisimma"}, {rank: "RN", name: "RUAN Danmei"},
  {rank: "RN", name: "SO Hang Yu"}, {rank: "RN", name: "TAI Ting Fong"}, {rank: "RN", name: "TAM Man Cho"},
  {rank: "RN", name: "TANG Chiu Wa"}, {rank: "RN", name: "TANG Yan Yan"}, {rank: "RN", name: "TANG Ying Shan"},
  {rank: "RN", name: "THAPA Tej Chandra"}, {rank: "RN", name: "TIU Tin Po"}, {rank: "RN", name: "TONG Chun Kit"},
  {rank: "RN", name: "TSANG Hing Nang"}, {rank: "RN", name: "TSANG Ka Fai"}, {rank: "RN", name: "TSANG Mei Ling"},
  {rank: "RN", name: "TSANG Pak Ki"}, {rank: "RN", name: "TSANG Suk Fan"}, {rank: "RN", name: "TSANG Wing Lam"},
  {rank: "RN", name: "TSANG Yuk Yi"}, {rank: "RN", name: "WONG Ching Hei"}, {rank: "RN", name: "WONG Hau Yan"},
  {rank: "RN", name: "WONG Hei Man Eugenia"}, {rank: "RN", name: "WONG Hoi Ching"}, {rank: "RN", name: "WONG Hoi Ngai"},
  {rank: "RN", name: "WONG Ka Chun"}, {rank: "RN", name: "WONG Si Hon"}, {rank: "RN", name: "WONG Sin Yan"},
  {rank: "RN", name: "WONG Sze Wai"}, {rank: "RN", name: "WONG Yu Fun"}, {rank: "RN", name: "WU Ka Wai"},
  {rank: "RN", name: "YEUNG Tsz Tung"}, {rank: "RN", name: "YIM Ho Pan"}, {rank: "RN", name: "YIP Yuen Ying"},
  {rank: "RN", name: "YUEN Wai Kwan"}
].sort((a, b) => a.name.localeCompare(b.name));

function handleLogin() {
  const user = document.getElementById("username").value.trim().toLowerCase();
  const pass = document.getElementById("password").value.trim();
  if (user === CORRECT_USER && pass === CORRECT_PASS) {
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("mainPage").style.display = "block";
    loadNurseList();
    loadFromCloud();
  } else {
    document.getElementById("errorMsg").textContent = "Error: Invalid username or password.";
  }
}

function loadNurseList() {
  const tbody = document.getElementById("nurseList");
  tbody.innerHTML = "";
  nurses.forEach(nurse => {
    const name = nurse.name;
    const row = document.createElement("tr");
    row.dataset.name = name;
    row.id = `row-${name.replace(/\s+/g,'-')}`;
    row.innerHTML = `
      <td>${nurse.rank}</td>
      <td style="text-align:left;">${name}</td>
      <td><input type="date" data-name="${name}" data-type="lecture" onchange="updateStats('${name}')"></td>
      <td><input type="date" data-name="${name}" data-index="0" data-type="case" onchange="updateStats('${name}')"></td>
      <td><input type="date" data-name="${name}" data-index="1" data-type="case" onchange="updateStats('${name}')"></td>
      <td><input type="date" data-name="${name}" data-index="2" data-type="case" onchange="updateStats('${name}')"></td>
      <td><input type="date" data-name="${name}" data-index="3" data-type="case" onchange="updateStats('${name}')"></td>
      <td><input type="date" data-name="${name}" data-index="4" data-type="case" onchange="updateStats('${name}')"></td>
      <td class="count" id="count-${name.replace(/\s+/g,'-')}">0</td>
    `;
    tbody.appendChild(row);
  });
  document.getElementById("totalNurses").textContent = nurses.length;
}

function updateStats(name) {
  const row = document.getElementById(`row-${name.replace(/\s+/g,'-')}`);
  const lectureInput = document.querySelector(`input[data-name="${name}"][data-type="lecture"]`);
  const cases = document.querySelectorAll(`input[data-name="${name}"][data-type="case"]`);
  
  let caseCount = 0;
  cases.forEach(inp => { if (inp.value) caseCount++; });
  document.getElementById(`count-${name.replace(/\s+/g,'-')}`).textContent = caseCount;
  
  if (lectureInput.value && caseCount === 5) row.classList.add('row-complete');
  else row.classList.remove('row-complete');
  
  updateDashboard();
}

function updateDashboard() {
  let fullyTrained = 0;
  nurses.forEach(n => {
    const row = document.getElementById(`row-${n.name.replace(/\s+/g,'-')}`);
    if (row && row.classList.contains('row-complete')) fullyTrained++;
  });
  const rate = Math.round((fullyTrained / nurses.length) * 100);
  document.getElementById("trainedNurses").textContent = fullyTrained;
  document.getElementById("completionRate").textContent = rate + "% Qualified";
  document.getElementById("progressBar").style.width = rate + "%";
}

function saveToCloud() {
  const data = {};
  nurses.forEach(n => {
    const name = n.name;
    const lec = document.querySelector(`input[data-name="${name}"][data-type="lecture"]`).value;
    const caseList = Array.from(document.querySelectorAll(`input[data-name="${name}"][data-type="case"]`)).map(i => i.value);
    data[name.replace(/[.#$/[\]]/g, "_")] = { lecture: lec, cases: caseList };
  });

  db.ref("training_data").set(data)
    .then(() => alert("‚úÖ Sync Successful! Data stored in Cloud."))
    .catch(err => alert("‚ùå Sync Failed: " + err.message));
}

function loadFromCloud() {
  const status = document.getElementById("syncStatus");
  db.ref("training_data").once("value", (snapshot) => {
    const data = snapshot.val();
    if (!data) { status.textContent = "üÜï No cloud records found. Start entering data!"; return; }
    
    nurses.forEach(n => {
      const safeName = n.name.replace(/[.#$/[\]]/g, "_");
      if (data[safeName]) {
        const lecInput = document.querySelector(`input[data-name="${n.name}"][data-type="lecture"]`);
        const caseInps = document.querySelectorAll(`input[data-name="${n.name}"][data-type="case"]`);
        if(lecInput) lecInput.value = data[safeName].lecture || "";
        caseInps.forEach((inp, idx) => { if(inp) inp.value = data[safeName].cases[idx] || ""; });
        updateStats(n.name);
      }
    });
    const lastTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    status.textContent = "üü¢ Connected: Cloud data loaded (Updated at " + lastTime + ")";
  });
}

function searchNurse() {
  const term = document.getElementById("searchInput").value.toLowerCase();
  document.querySelectorAll("#nurseList tr").forEach(row => {
    row.style.display = row.dataset.name.toLowerCase().includes(term) ? "" : "none";
  });
}

function exportToCSV() {
  let csv = "\uFEFFRank,Nurse Name,Lecture,Case 1,Case 2,Case 3,Case 4,Case 5,Total\n";
  document.querySelectorAll("#nurseList tr").forEach(tr => {
    if (tr.style.display === "none") return;
    const cells = Array.from(tr.children);
    const lecture = tr.querySelector('input[data-type="lecture"]').value;
    const cases = Array.from(tr.querySelectorAll('input[data-type="case"]')).map(i => i.value).join(",");
    csv += `${cells[0].innerText},${cells[1].innerText},${lecture},${cases},${cells[8].innerText}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'PACU_Record_Backup.csv';
  a.click();
}
</script>
</body>
</html>
